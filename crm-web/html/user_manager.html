<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户管理</title>

    <link rel="shortcut icon" href="favicon.ico">
    <link href="css/bootstrap.min14ed.css?v=3.3.6" rel="stylesheet">
    <link href="css/font-awesome.min93e3.css?v=4.4.0" rel="stylesheet">
    <link href="css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/style.min862f.css?v=4.1.0" rel="stylesheet">
    <link href="css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <script src="js/plugins/sweetalert/sweetalert.min.js"></script>
</head>
<body style="background: rgb(240,242,245)">
    <div class="wrapper wrapper-content animated fadeInRight">
        <!-- Panel Other -->
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>用户管理</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-wrench"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#">选项1</a>
                        </li>
                        <li><a href="#">选项2</a>
                        </li>
                    </ul>
                    <a class="close-link">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">
                <div class="row row-lg">


                    <div class="col-sm-12">
                        <!-- Example Events -->
                        <div class="example-wrap">
                            <div class="example">
                                <div class="pull-left" style="margin-bottom:12px;">
                                    <form class="form-inline" role="form" id="searchForm">
                                        <div class="form-group">
                                            <label>用户账号：</label>
                                            <input type="text" name="phone" class="form-control input-sm" placeholder="请输入用户账号查询">
                                        </div>
                                        <div class="form-group">
                                            <label>用户名称：</label>
                                            <input type="text" name="name" class="form-control input-sm" placeholder="请输入用户名称查询">
                                        </div>
                                        <div class="form-group">
                                            <label>用户状态：</label>
                                            <select name="flag" class="form-control input-sm" style="height: 35px">
                                                <option value="1">正常</option>
                                                <option value="0">禁用</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="btn-group hidden-xs pull-right" id="exampleTableEventsToolbar" role="group">
                                    <button type="button" id="searchBut" class="btn btn-outline btn-default">
                                        <i class="glyphicon glyphicon-search" aria-hidden="true"></i>
                                        搜索
                                    </button>
                                    <button type="button" class="btn btn-outline btn-default" data-toggle="modal" data-target="#myModal">
                                        <i class="glyphicon glyphicon-plus" aria-hidden="true"></i>
                                        新建
                                    </button>
                                </div>
                                <table class="table table-bordered table-hover" data-height="400" style="margin-bottom:0px" data-mobile-responsive="true">
                                    <thead>
                                    <tr>
                                        <th>编号</th>
                                        <th>用户姓名</th>
                                        <th>用户电话</th>
                                        <th>用户角色</th>
                                        <th>用户状态</th>
                                        <th>创建时间</th>
                                        <th>
                                            <div align="center">操作</div>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="dataRow">

                                    </tbody>
                                </table>
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="pull-left" style="margin-top:15px">
                                            <p>显示 1 到 10 项，共 <lable id="pageSize">25</lable> 项</p>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="pull-right">
                                            <ul class="pagination">
                                                <li class="prev"><a>«</a></li>
                                                <li  class="next"><a>»</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <!-- End Example Events -->
                    </div>
                </div>
            </div>
        </div>
        <!-- End Panel Other -->
    </div>
    <!--                              添加用户                                    -->
    <div class="modal inmodal in" id="myModal" tabindex="-1" role="dialog" aria-hidden="true" style="display: none">
        <div class="modal-dialog" style="width:800px;margin-top:20px;">
            <div class="modal-content animated flipInY">
                <form id="addForm">
                    <div class="modal-header" style="height:50px;padding-top:15px;">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                        <div class="pull-left"><h4>添加用户</h4></div>
                    </div>
                    <div class="modal-body" style="background-color:#fff;padding-bottom:0px;padding-top:10px;">
                        <table class="table table-bordered">
                            <tr>
                                <th style="background-color:#F5F5F6" width="15%">
                                    <span style="color:#000">编号</span>
                                </th>
                                <td width="35%">
                                    <input type="email"  class="form-control input-sm" disabled placeholder="由系统生成">
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color:#F5F5F6">
                                    <span style="color:#000">用户名称</span>
                                </th>
                                <td>
                                    <input type="text" name="name" class="form-control input-sm" placeholder="用户名称">
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color:#F5F5F6">
                                    <span style="color:#000">手机号</span>
                                </th>
                                <td>
                                    <input type="tel" name="phone" class="form-control input-sm" maxlength="11" placeholder="手机号">
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color:#F5F5F6">
                                    <span style="color:#000">登录密码</span>
                                </th>
                                <td>
                                    <input type="password" name="password" class="form-control input-sm" disabled placeholder="默认:crm123456">
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color:#F5F5F6">
                                    <span style="color:#000">分配角色</span>
                                </th>
                                <td>
                                    <select name="roleId" class="form-control input-sm" style="height: 35px">
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!------------------------------------修改用户  -------------------------------->
    <div class="modal inmodal in" id="myModal2" tabindex="-1" role="dialog" aria-hidden="true" style="display: none">
        <div class="modal-dialog" style="width:800px;margin-top:20px;">
            <div class="modal-content animated flipInY">
                <form id="updForm">
                    <div class="modal-header" style="height:50px;padding-top:15px;">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                        <div class="pull-left"><h4>修改用户</h4></div>
                    </div>
                    <div class="modal-body" style="background-color:#fff;padding-bottom:0px;padding-top:10px;">
                        <table class="table table-bordered">
                            <tr>
                                <th style="background-color:#F5F5F6" width="15%">
                                    <span style="color:#000">编号</span>
                                </th>
                                <td width="35%">
                                    <input type="text" class="form-control input-sm" disabled placeholder="由系统生成">
                                    <input type="hidden" name="id"value="">
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color:#F5F5F6">
                                    <span style="color:#000">用户名称</span>
                                </th>
                                <td>
                                    <input type="text" name="name" class="form-control input-sm" placeholder="用户名称">
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color:#F5F5F6">
                                    <span style="color:#000">手机号</span>
                                </th>
                                <td>
                                    <input type="tel" name="phone" class="form-control input-sm" maxlength="11" placeholder="手机号">
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color:#F5F5F6">
                                    <span style="color:#000">用户状态</span>
                                </th>
                                <td>
                                    <select name="flag" class="form-control input-sm" style="height: 35px">
                                        <option value="true">正常</option>
                                        <option value="false">禁用</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color:#F5F5F6">
                                    <span style="color:#000">分配角色</span>
                                </th>
                                <td>
                                    <select name="roleId" class="form-control input-sm" style="height: 35px">
                                        <option value="1">管理员</option>
                                        <option value="2">总监</option>
                                        <option value="3">经理</option>
                                        <option value="4">员工</option>
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js?v=2.1.4"></script>
    <script src="js/bootstrap.min.js?v=3.3.6"></script>
    <script src="js/content.min.js?v=1.0.0"></script>
    <script src="js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>
    <script src="js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="js/demo/bootstrap-table-demo.min.js"></script>
    <script src="js/utils.js"></script>
    <script>

        $("#searchBut").next().click(function () {
            var pageParam = {
                "pageIndex":1,
                "pageSize":10,
                "condition":""
            };
            $.get("http://localhost:8080/role/all",pageParam,function (result) {
                console.log(result.data.records);
                var data = "";
                $.each(result.data.records,function (i,v) {
                    data +=`
                         <option value="${v.id}">${v.description}</option>
                    `;
                });
                $(data).appendTo($("#addForm select[name='roleId']"))
            })
        });

        page(1);
        //-------------搜索按钮点击事件
        $("#searchBut").click(function () {
            page(1);
        });

        //-------------页码点击事件
        $(".pagination").on("click",".page a",function (event) {
            var pageIndex1 = $(".active").text();
            var pageIndex = $(this).text();
            if (pageIndex1!=pageIndex){
                page(pageIndex);
            }
        });

        //-------------上一页点击
        $(".prev").click(function () {
            var pageIndex = $(".active").text();
            page(pageIndex-1)
        });

        //-------------下一页点击
        $(".next").click(function () {
            var pageIndex = $(".active").text();
            page(Number(pageIndex)+1)
        });


        //-------------修改按钮
        $("#dataRow").on("click",".glyphicon-pencil",function () {

            var pageParam = {
                "pageIndex":1,
                "pageSize":10,
                "condition":""
            };
            $.ajaxSettings.async = false;
            $.get("/role/all",pageParam,function (result) {
                console.log(result.data.records);
                var data = "";
                $.each(result.data.records,function (i,v) {
                    data +=`
                         <option value="${v.id}">${v.description}</option>
                    `;
                });
                $(data).appendTo($("#updForm select[name='roleId']"))
            });
            $.ajaxSettings.async = true;
            var userId = $(this).attr("data-id");

            $.ajax({
                //http://127.0.0.1:8080/
                url:"/user/"+userId,
                type:"GET",
                headers:{'Authorization':''+getToken()+''},
                success:function (result) {
                    if (result.code == 401){
                        console.log("toke失效");
                        window.location.href = "login.html";
                        window.event.returnValue = false;
                        return false;
                    }
                    if (result.code == 1){
                        console.log(result);
                        console.log(result.data);
                        var user = result.data;
                        $("#updForm input[name='id']").val(user.id);
                        $("#updForm input[name='name']").val(user.name);
                        $("#updForm input[name='phone']").val(user.phone);
                        $("#updForm select[name='roleId']").val(user.roleId);
                        $("#updForm select[name='flag']").val(""+user.flag+"");
                    }
                }
            });
        });

        //-------------修改
        $("#updForm").submit(function(){
            var aryData = $("#updForm").serializeArray();
            var data = formToJson(aryData);
            // console.log(JSON.parse(data));
            $.ajax({
                type:"put",
                url:"/user/upd",
                headers:{'Authorization':''+getToken()+''},
                contentType:"application/json",
                dataType:"json",
                data:JSON.stringify(data),
                success:function (result) {
                    if (result.data){
                        swal("修改成功！","",
                            "success"
                        )
                        $("#myModal2 input[type=text]").val("")
                        $(".modal-backdrop").hide();
                        $("#myModal2").removeClass("in").hide()
                        page(1)
                    }
                }
            });
            return false;
        });

        //-------------删除
        $("#dataRow").on("click",".glyphicon-remove",function () {
            var param = $(this).attr("data-id");
            swal({
                    title:"您确定要删除这条信息吗",
                    text:"删除后将无法恢复，请谨慎操作！",
                    type:"warning",
                    showCancelButton:true,
                    confirmButtonColor:"#DD6B55",
                    confirmButtonText:"确定",
                    cancelButtonText:"取消",
                    closeOnConfirm:false,
                    closeOnCancel:false},
                function(isConfirm){
                    if(isConfirm){
                        $.ajax({
                            type:"delete",
                            url:"/user/del/"+param+"",
                            headers:{'Authorization':''+getToken()+''},
                            success:function (result) {
                                console.log(result);
                                if (result.data){
                                    swal("删除成功！","您已经永久删除了这条信息。",
                                        "success",
                                    );
                                    page(1)
                                }else {
                                    swal("删除失败！",result.msg,
                                        "warning",
                                    );
                                    return true;
                                }
                            }
                        });


                    }else{
                        swal("已取消",
                            "您取消了删除操作！","error"
                        )
                    }
                }
            )
            var userId = $(this).attr("data-id");
        });

        //-------------添加
        $("#addForm").submit(function(){
            var aryData = $("#addForm").serializeArray();
            var data = formToJson(aryData);

            $.ajax({
                //http://127.0.0.1:8080/
                url:"/user/add",
                type:"post",
                data:data,
                headers:{'Authorization':''+getToken()+''},
                success:function (result) {
                    if (result.code == 401){
                        console.log("toke失效");
                        window.location.href = "login.html";
                        window.event.returnValue = false;
                        return false;
                    }
                    if (result.code == 1){
                        if (result.data){
                            swal("添加成功！","",
                                "success"
                            )
                            $("#myModal input[type=text]").val("")
                            $(".modal-backdrop").hide();
                            $("#myModal").removeClass("in").hide()
                            page(1);
                        }
                    }
                }
            });

            // $.post("http://localhost:8080/user/add",data,function (result) {
            //     console.log(result.data);
            //     if (result.data){
            //         swal("添加成功！","",
            //             "success"
            //         )
            //         $("#myModal input[type=text]").val("")
            //         $(".modal-backdrop").hide();
            //         $("#myModal").removeClass("in").hide()
            //     }
            // });
            return false;
        });

        //-------------翻页
        function page(pageIndex) {
            if (isNaN(pageIndex)){
                return false;
            }
            var str = $("#searchForm").serializeArray();
            var condition = JSON.stringify(formToJson(str));
            // var pageIndex = $(".pagination .active").text();
            var pageSize = 10;
            var pageParam = {
                "pageIndex":pageIndex,
                "pageSize":pageSize,
                "condition":condition
            };
            $.ajax({
                //http://127.0.0.1:8080/
                url:"/user/all/",
                type:"GET",
                data: pageParam,
                headers:{'Authorization':''+getToken()+''},
                success:function (result) {
                    if (result.code == 401){
                        console.log("toke失效");
                        window.location.href = "login.html";
                        window.event.returnValue = false;
                        return false;
                    }
                    if (result.code == 1){
                        var data = result.data;
                        //---------------------渲染数据
                        var tableData = "";
                        $.each(data.records,function (i,v) {
                            tableData += `
                                <tr class="dataRow">
                                    <td>${i + 1}</td>
                                    <td>${v.name}</td>
                                    <td>${v.phone}</td>
                                    <td>${roleId(v.roleId)}</td>
                                    <td>${parseFlag(v.flag)}</td>
                                    <td>${v.creatTime}</td>
                                    <td align="center">
                                        <div>
                                            &nbsp;&nbsp;
                                            <a title="修改" data-toggle="modal" data-target="#myModal2" style="color:#CC6600">
                                                <i data-id="${v.id}" class="glyphicon glyphicon-pencil" aria-hidden="true"></i>
                                            </a>
                                            &nbsp;&nbsp;
                                            <a title="删除" style="color:#CC0000">
                                                <i data-id="${v.id}" class="glyphicon glyphicon-remove" aria-hidden="true"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        $("#dataRow").empty();
                        $(tableData).appendTo($("#dataRow"))

                        //---------------------渲染分页按钮
                        var dataCount = data.total;
                        var pageSize = data.pageSize
                        var len = 0;
                        if ((dataCount%pageSize)==0){
                            len = parseInt(dataCount/pageSize);
                        }else {
                            len =parseInt((dataCount/pageSize)+1)
                        }
                        //拼接的字符串
                        var strData = "";
                        if (Number(pageIndex)+2<=len && pageIndex-2>=1){
                            strData += `
                        <li class="page"><a>${pageIndex-2}</a></li>
                        <li class="page"><a>${pageIndex-1}</a></li>
                        <li class="active page"><a>${pageIndex}</a></li>
                        <li class="page"><a>${Number(pageIndex)+Number(1)}</a></li>
                        <li class="page"><a>${Number(pageIndex)+Number(2)}</a></li>

                    `;
                        }else {
                            var i = pageIndex;
                            if (Number(i)+5>len){
                                i=len-4;
                            }
                            if (len-5<=1){
                                i=1;
                            }
                            for (;i<Number(pageIndex)+5 & i<=len;i++){
                                if (i==data.pageIndex){
                                    strData+= `
                                                 <li class="active page"><a>${i}</a></li>
                                            `
                                }else {
                                    strData+= `
                                                 <li class="page"><a>${i}</a></li>
                                            `
                                }
                            }
                        }
                        $(".page").remove();
                        $(".prev").after(strData);
                        $("#pageSize").text(data.total);
                        $(".next").removeClass("disabled");
                        $(".prev").removeClass("disabled");
                        if (pageIndex==1){
                            $(".prev").addClass("disabled");
                        }
                        if (pageIndex==len){
                            $(".next").addClass("disabled");
                        }
                    }
                }
            });
        }

        function roleId(roleId) {
            if (roleId==1){
                return "管理员"
            }
            if (roleId==2){
                return "总监"
            }
            if (roleId==3){
                return "总经理"
            }
            if (roleId==4){
                return "员工"
            }
        }
        function parseFlag(flag) {
            if (flag){
                return "正常"
            }
            return "封禁"
        }
    </script>
</body>
</html>